<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>何分何秒君</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    .question {
      font-size: 24px;
      margin: 20px 0;
    }
    .button-container button {
      font-size: 20px;
      padding: 10px 20px;
      margin: 5px;
    }
    .input-container input {
      font-size: 24px;
      width: 80px;
      text-align: center;
      margin: 5px;
    }
    .fraction-display {
      display: inline-block;
      text-align: center;
    }
    .fraction-display .numerator {
      border-bottom: 1px solid #000;
    }
    .fraction-display .denominator {
    }
    .answer-section {
      margin-top: 20px;
    }
    .mixed-input {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .fraction-input {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .fraction-input input {
      width: 80px;
      font-size: 24px;
      text-align: center;
    }
    .input {
      font-size: 24px;
      width: 80px;
      text-align: center;
    }
    .result {
      margin-top: 20px;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <h1>何分何秒君</h1>
  <div class="button-container">
    <button onclick="generateRandomQuestion()">スタート / 次の問題</button>
  </div>
  <div class="question" id="question"></div>
  <div class="answer-section" id="answerSection"></div>
  <div class="result" id="result"></div>

  <script>
    let currentAnswer;
    let currentType;
    let correctStreak = 0;

    function gcd(a, b) {
      return b ? gcd(b, a % b) : a;
    }

    function simplifyFraction(numerator, denominator) {
      const g = gcd(numerator, denominator);
      return [numerator / g, denominator / g];
    }

    function generateRandomQuestion() {
      const types = ['minToSec', 'hourToMin', 'secToMin', 'minToHour'];
      const randomType = types[Math.floor(Math.random() * types.length)];
      generateQuestion(randomType);
    }

    function generateQuestion(type) {
      currentType = type;
      let questionText = '';
      let answer;
      document.getElementById('result').textContent = '';

      if (type === 'minToSec') {
        const m = Math.floor(Math.random() * 10);
        const s = [0, 15, 20, 30, 45][Math.floor(Math.random() * 5)];
        questionText = `${m}分${s}秒は何秒？`;
        answer = m * 60 + s;
        showIntegerInput();

      } else if (type === 'hourToMin') {
        const h = Math.floor(Math.random() * 3);
        const m = [0, 15, 20, 30, 45][Math.floor(Math.random() * 5)];
        questionText = `${h}時間${m}分は何分？`;
        answer = h * 60 + m;
        showIntegerInput();

      } else if (type === 'secToMin') {
        const totalSeconds = (Math.floor(Math.random() * 4 + 1)) * 60 + [15, 20, 30, 45][Math.floor(Math.random() * 4)];
        questionText = `${totalSeconds}秒は何分？`;
        const whole = Math.floor(totalSeconds / 60);
        const remainder = totalSeconds % 60;
        const [num, den] = simplifyFraction(remainder, 60);
        answer = { whole, num, den };
        showFractionInput(answer.num !== 0);

      } else if (type === 'minToHour') {
        const totalMinutes = (Math.floor(Math.random() * 2)) * 60 + [15, 20, 30, 45][Math.floor(Math.random() * 4)];
        questionText = `${totalMinutes}分は何時間？`;
        const whole = Math.floor(totalMinutes / 60);
        const remainder = totalMinutes % 60;
        const [num, den] = simplifyFraction(remainder, 60);
        answer = { whole, num, den };
        showFractionInput(answer.num !== 0);
      }

      currentAnswer = answer;
      document.getElementById('question').textContent = questionText;
    }

    function showIntegerInput() {
      document.getElementById('answerSection').innerHTML = `
        <input id="intInput" type="number" class="input" autofocus>
        <button onclick="checkAnswer()">答える！</button>
      `;
    }

    function showFractionInput(showFractionPart) {
      if (!showFractionPart) {
        document.getElementById('answerSection').innerHTML = `
          <input id="wholeInput" type="number" class="input" autofocus>
          <button onclick="checkAnswer()">答える！</button>
        `;
        return;
      }

      document.getElementById('answerSection').innerHTML = `
        <div class="mixed-input">
          <input id="wholeInput" type="number" placeholder="整数" class="input">
          <div class="fraction-input">
            <input id="numInput" type="number" placeholder="分子" class="input">
            <span style="border-bottom: 1px solid #000; width: 80px;"></span>
            <input id="denInput" type="number" placeholder="分母" class="input">
          </div>
        </div>
        <button onclick="checkAnswer()">答える！</button>
      `;

      setTimeout(() => document.getElementById('wholeInput').focus(), 100);
      document.getElementById('wholeInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') document.getElementById('numInput').focus();
      });
      document.getElementById('numInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') document.getElementById('denInput').focus();
      });
      document.getElementById('denInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') checkAnswer();
      });
    }

    function checkAnswer() {
      let correct = false;

      if (typeof currentAnswer === 'number') {
        const userAnswer = parseInt(document.getElementById('intInput').value);
        correct = userAnswer === currentAnswer;
      } else {
        const w = parseInt(document.getElementById('wholeInput').value) || 0;
        const n = parseInt(document.getElementById('numInput')?.value) || 0;
        const d = parseInt(document.getElementById('denInput')?.value) || 1;
        const [num, den] = simplifyFraction(n, d);
        correct = (w === currentAnswer.whole && num === currentAnswer.num && den === currentAnswer.den);
      }

      const resultText = document.getElementById('result');
      if (correct) {
        correctStreak++;
        resultText.innerHTML = `🎉 <span style="color: green; font-size: 24px; font-weight: bold;">正解！</span> 現在 <strong>${correctStreak}</strong> 問連続正解中！`;
      } else {
        correctStreak = 0;
        resultText.textContent = `残念。正解は ${formatAnswer(currentAnswer)} だよ。`;
      }
    }

    function formatAnswer(ans) {
      if (typeof ans === 'number') return `${ans}秒`;
      if (ans.num === 0) return `${ans.whole}`;
      return `<span class="fraction-display">
                <div>${ans.whole}</div>
                <div class="numerator">${ans.num}</div>
                <div>${ans.den}</div>
              </span>`;
    }
  </script>
</body>
</html>
